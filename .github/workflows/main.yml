name: deploy

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the "main" branch
  push:
    branches: [ "main" ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  # build the .NET backend
  deploy-backend:
    env:
      # vars needed to upload lambda function
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_LAMBDA_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_LAMBDA_SECRET_KEY }}
      # vars needed to updated RDS database
      fintrak_dbserver: ${{ secrets.AWS_DB_HOST }}
      fintrak_dbuser: ${{ secrets.AWS_DB_USER }}
      fintrak_dbpassword: ${{ secrets.AWS_DB_PASSWORD }}
  
    runs-on: ubuntu-latest

    steps:
      # setup
      - name: Check-out repo
        uses: actions/checkout@v3
        
      # build app and update db
      - name: Build backend
        working-directory: ./backend
        run: |
          dotnet publish --output "./bin/publish" --configuration "Release" --framework "net6.0" /p:GenerateRuntimeConfigurationFiles=true --runtime linux-x64 --self-contained false
        
      - name: Update database
        working-directory: ./backend
        run: |
          dotnet tool install --global dotnet-ef
          dotnet tool restore
          dotnet ef database update
        
      # deploy to lambda
      - name: Install AWS CLI
        uses: unfor19/install-aws-cli-action@v1.0.3

      - name: Zip backend
        working-directory: ./backend/bin/publish
        run: zip backend.zip *
          
      - name: Update Lambda env vars
        working-directory: ./backend/bin/publish
        run: aws lambda update-function-configuration --function-name FintrakBackend --region us-east-1 --environment "Variables={fintrak_dbserver=$fintrak_dbserver,fintrak_dbuser=$fintrak_dbuser,fintrak_dbpassword=$fintrak_dbpassword}"

      - name: Upload zip to Lambda
        working-directory: ./backend/bin/publish
        run: aws lambda update-function-code --function-name FintrakBackend --zip-file fileb://backend.zip --region us-east-1
          
  #deploy-frontend:
    #runs-on: ubuntu-latest
    
          

